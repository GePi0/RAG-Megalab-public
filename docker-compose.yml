services:
  orchestrator:
    build: ./orchestrator
    container_name: orchestrator
    command: uvicorn main:app --host 0.0.0.0 --port 8001
    ports:
      - "8001:8001"
    environment:
      - CONTEXT_SERVICE_URL=http://context_service:8002/add
      - WORKER_URL=http://worker_mcp:8003
      - KAFKA_BROKER=redpanda:9092
      - KAFKA_TOPIC=rag_logs_v2
      - STATE_TOPIC=state_update
      - LOG_PATH=/storage/logs/orchestrator/events.log
      - PYTHONUNBUFFERED=1
      - WORKER_TIMEOUT=60   
      - DOCKER_SDK_ACTIVE=false       # activar true en QA
      - DRY_RUN=true
      - HEALTH_INTERVAL_SEC=60
      - RETRY_LIMIT=3
      - ELASTIC_URL=http://elasticsearch:9200/state_manager_v1/_search
      - ELASTIC_INDEX_INCIDENTS=incident_events_v1
      - KAFKA_HEALTH_TOPIC=health_status
    volumes:
      - ./storage/logs/orchestrator:/storage/logs/orchestrator
      - ./storage/chroma:/storage/chroma
      - ./storage/policies:/app/policies
      - ./storage/projects:/workspace/projects
    depends_on:
      - context_service
      - worker_mcp
    networks:
      - megalab_net
    restart: unless-stopped

  context_service:
    build: ./context_service
    container_name: context_service
    command: uvicorn main:app --host 0.0.0.0 --port 8002
    ports:
      - "8002:8002"
    environment:
      - CHROMA_DB_PATH=/app/chroma           # persistente
      - CHROMA_COLLECTION=rag_contexts
      - EMBEDDING_MODEL=nomic-embed-text
    volumes:
      - ./storage/chroma:/app/chroma
    networks:
      - megalab_net
    restart: unless-stopped

  worker_mcp:
    build: ./worker_mcp
    container_name: worker_mcp
    command: uvicorn main:app --host 0.0.0.0 --port 8003
    ports:
      - "8003:8003"
    environment:
      - KAFKA_BROKER=redpanda:9092
      - KAFKA_TOPIC=rag_logs_v2
      - STATE_TOPIC=state_update
      - CONTEXT7_URL=http://context7:8080/mcp   # ðŸ§© aÃ±adido
      - OLLAMA_BASE_URL=http://ollama-service:11434
    networks:
      - megalab_net
    restart: unless-stopped

  api:
    build: ./api
    container_name: api
    command: uvicorn main:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    environment:
      - ORCHESTRATOR_URL=http://orchestrator:8001    # ðŸ”¹ referenciado por nombre DNS interno
      - KAFKA_BROKER=redpanda:9092
      - KAFKA_TOPIC=rag_logs_v2
      - PYTHONUNBUFFERED=1
    depends_on:
      - orchestrator
    networks:
      - megalab_net
    restart: unless-stopped

  redpanda:
    image: redpandadata/redpanda:v24.2.9
    container_name: redpanda
    command:
      - redpanda start
      - --overprovisioned
      - --smp 1
      - --memory 1G
      - --node-id 0
      - --check=false
      - --set redpanda.enable_transactions=false
      - --set redpanda.enable_idempotence=false
      - --advertise-kafka-addr redpanda:9092
      - --kafka-addr redpanda:9092
    ports:
      - "9092:9092"
      - "9644:9644"
    volumes:
      - ./storage/redpanda:/var/lib/redpanda/data
    networks:
      - megalab_net
    restart: unless-stopped

  ollama-service:
    image: ollama/ollama:latest
    container_name: ollama-service
    volumes:
      - ollama:/root/.ollama   # cacheâ€¯deâ€¯modelos
    networks:
      - megalab_net
    ports:
      - "11434:11434"          # expuesto localmenteâ€¯porâ€¯si quieres probarâ€¯API
    restart: unless-stopped

  kafka_consumer:
    build: ./kafka_consumer
    container_name: kafka_consumer
    environment:
      - KAFKA_BROKER=redpanda:9092
      - KAFKA_TOPIC=rag_logs_v2
    depends_on:
      - redpanda
    networks:
      - megalab_net
    restart: unless-stopped

  context_tester:
    image: python:3.10-slim
    container_name: context_tester
    volumes:
      - .:/tests
    working_dir: /tests   
    command: ["bash", "-c", "pip install --no-cache-dir requests && python context_test.py"]
    networks:
      - megalab_net
    depends_on:
      - context_service
      - ollama-service

  context7:
    image: mcp/context7:latest
    container_name: context7
    ports:
      - "8099:8080"
    environment:
      - LOG_LEVEL=info
    networks:
      - megalab_net
    restart: unless-stopped

volumes:
  ollama:

networks:
  megalab_net:
    external: true
